<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>04.05 - Storage, Clipboard e Drag & Drop</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .section h2 {
            color: #38b2ac;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #38b2ac;
        }

        .demo-area {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid #e9ecef;
        }

        button {
            background: linear-gradient(135deg, #38b2ac 0%, #2c7a7b 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
            font-weight: bold;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 178, 172, 0.4);
        }

        button.danger {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
        }

        .log {
            background: #2d3748;
            color: #48bb78;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            max-height: 250px;
            overflow-y: auto;
            font-size: 13px;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #48bb78;
            padding-left: 10px;
        }

        .code-display {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            font-size: 14px;
        }

        /* Storage Demo */
        .storage-display {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            margin: 15px 0;
        }

        .storage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f7fafc;
            border-radius: 6px;
            border-left: 4px solid #38b2ac;
        }

        .storage-key {
            font-weight: bold;
            color: #2d3748;
        }

        .storage-value {
            color: #718096;
            font-family: monospace;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            margin: 5px 0;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #38b2ac;
        }

        /* Clipboard Demo */
        .clipboard-demo {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 15px 0;
        }

        .clipboard-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }

        .copyable-text {
            background: #edf2f7;
            padding: 15px;
            border-radius: 6px;
            user-select: all;
            cursor: pointer;
            border: 2px dashed #cbd5e0;
            transition: all 0.3s;
        }

        .copyable-text:hover {
            background: #e6fffa;
            border-color: #38b2ac;
        }

        /* Drag and Drop */
        .drag-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 15px 0;
        }

        .draggable-item {
            background: linear-gradient(135deg, #38b2ac20, #2c7a7b20);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: move;
            border: 2px solid #38b2ac;
            user-select: none;
            transition: all 0.3s;
        }

        .draggable-item:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(56, 178, 172, 0.3);
        }

        .draggable-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .drop-zone {
            min-height: 200px;
            background: #f7fafc;
            border: 3px dashed #cbd5e0;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
        }

        .drop-zone.drag-over {
            background: #e6fffa;
            border-color: #38b2ac;
            border-style: solid;
        }

        .drop-zone h4 {
            color: #718096;
            text-align: center;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #38b2ac;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }

        .file-drop-zone {
            min-height: 200px;
            background: #f7fafc;
            border: 3px dashed #cbd5e0;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            margin: 15px 0;
            transition: all 0.3s;
        }

        .file-drop-zone.drag-over {
            background: #e6fffa;
            border-color: #38b2ac;
            border-style: solid;
        }

        .file-drop-zone i {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid;
        }

        .alert-success {
            background: #c6f6d5;
            border-color: #48bb78;
            color: #22543d;
        }

        .alert-info {
            background: #bee3f8;
            border-color: #4299e1;
            color: #2c5282;
        }

        @media (max-width: 768px) {
            .clipboard-demo,
            .drag-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíæ 04.05 - Storage, Clipboard e Drag & Drop</h1>

        <!-- Sezione 1: storage Event -->
        <div class="section">
            <h2>1. storage - Sincronizzazione tra Tab</h2>
            <p>L'evento storage viene attivato quando localStorage o sessionStorage cambia in un'altra tab/finestra.</p>
            
            <div class="demo-area">
                <div class="alert alert-info">
                    <strong>üí° Test Multi-Tab:</strong> Apri questa pagina in due tab diverse. Le modifiche in una tab saranno visibili nell'altra!
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                    <div>
                        <label><strong>Chiave:</strong></label>
                        <input type="text" id="storage-key" placeholder="es: username" value="counter">
                    </div>
                    <div>
                        <label><strong>Valore:</strong></label>
                        <input type="text" id="storage-value" placeholder="es: Mario" value="0">
                    </div>
                </div>
                
                <button onclick="saveToStorage()">üíæ Salva in localStorage</button>
                <button onclick="incrementCounter()">‚ûï Incrementa Counter</button>
                <button onclick="clearStorage()" class="danger">üóëÔ∏è Cancella Tutto</button>
                
                <div class="storage-display" id="storage-display">
                    <p style="color: #718096; text-align: center;">Nessun dato salvato</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="storage-event-count">0</div>
                        <div class="stat-label">Eventi storage</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="storage-items-count">0</div>
                        <div class="stat-label">Items salvati</div>
                    </div>
                </div>
                
                <div class="code-display">
// storage event - Solo tra TAB/FINESTRE diverse!
window.addEventListener('storage', function(e) {
    console.log('üîÑ Storage changed in another tab:');
    console.log('Key:', e.key);
    console.log('Old Value:', e.oldValue);
    console.log('New Value:', e.newValue);
    console.log('URL:', e.url);
    console.log('Storage Area:', e.storageArea);
    
    // Sincronizza UI con i nuovi dati
    if (e.key === 'userPreferences') {
        updateUIFromStorage(e.newValue);
    }
    
    // Aggiorna cache locale
    if (e.key === 'sharedData') {
        localCache.set(e.key, JSON.parse(e.newValue));
    }
});

// ‚ö†Ô∏è IMPORTANTE: storage event NON si attiva nella tab corrente!
// Si attiva solo nelle ALTRE tab che hanno la pagina aperta

// Salva dati
localStorage.setItem('counter', '42');

// Leggi dati
const counter = localStorage.getItem('counter');

// Rimuovi
localStorage.removeItem('counter');

// Cancella tutto
localStorage.clear();</div>
            </div>
            <div id="log1" class="log"></div>
        </div>

        <!-- Sezione 2: copy Event -->
        <div class="section">
            <h2>2. copy - Personalizzazione Copia</h2>
            <p>Intercetta e modifica il testo copiato negli appunti.</p>
            
            <div class="demo-area">
                <div class="clipboard-demo">
                    <div class="clipboard-box">
                        <h4>üìã Copia Normale</h4>
                        <div class="copyable-text" id="normal-text">
                            Seleziona questo testo e copialo (Ctrl+C). Non verr√† modificato.
                        </div>
                    </div>
                    
                    <div class="clipboard-box">
                        <h4>‚ú® Copia con Attribution</h4>
                        <div class="copyable-text" id="attributed-text">
                            Seleziona questo testo e copialo (Ctrl+C). Verr√† aggiunta automaticamente l'attribuzione!
                        </div>
                    </div>
                </div>
                
                <button onclick="copyProgrammatically()">üìã Copia Programmaticamente</button>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="copy-count">0</div>
                        <div class="stat-label">Eventi copy</div>
                    </div>
                </div>
                
                <div class="code-display">
// copy event - Modifica testo copiato
document.addEventListener('copy', function(e) {
    const selection = window.getSelection().toString();
    
    if (selection) {
        // Previeni copia normale
        e.preventDefault();
        
        // Aggiungi attribution
        const attribution = `\n\n---\nFonte: ${document.title}\nURL: ${location.href}`;
        const modifiedText = selection + attribution;
        
        // Imposta clipboard con testo modificato
        e.clipboardData.setData('text/plain', modifiedText);
        
        console.log('‚úÇÔ∏è Copied with attribution');
    }
});

// Copia programmatica (moderna)
async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        console.log('‚úÖ Copied!');
    } catch (err) {
        console.error('‚ùå Copy failed:', err);
    }
}

// Copia programmatica (legacy)
function copyToClipboardLegacy(text) {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
}</div>
            </div>
            <div id="log2" class="log"></div>
        </div>

        <!-- Sezione 3: paste Event -->
        <div class="section">
            <h2>3. paste - Elaborazione Incolla</h2>
            <p>Intercetta e processa il contenuto incollato.</p>
            
            <div class="demo-area">
                <div style="margin: 15px 0;">
                    <h4>üéØ Campo con Validazione Paste</h4>
                    <p style="color: #718096; font-size: 14px; margin: 5px 0;">
                        Prova a incollare testo con spazi o caratteri speciali - verranno automaticamente puliti
                    </p>
                    <input type="text" id="paste-input" placeholder="Incolla qui del testo (Ctrl+V)">
                </div>
                
                <div style="margin: 15px 0;">
                    <h4>üìù Area di testo con Paste Processing</h4>
                    <p style="color: #718096; font-size: 14px; margin: 5px 0;">
                        Incolla del testo - verr√† convertito in MAIUSCOLO automaticamente
                    </p>
                    <textarea id="paste-textarea" rows="4" placeholder="Incolla qui del testo (Ctrl+V)"></textarea>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="paste-count">0</div>
                        <div class="stat-label">Eventi paste</div>
                    </div>
                </div>
                
                <div class="code-display">
// paste event - Elabora testo incollato
element.addEventListener('paste', function(e) {
    // Previeni paste normale
    e.preventDefault();
    
    // Ottieni testo dagli appunti
    const pastedText = e.clipboardData.getData('text/plain');
    
    // Pulisci/processa il testo
    const cleanText = pastedText
        .trim()
        .replace(/\s+/g, ' ')  // Normalizza spazi
        .replace(/[^\w\s]/gi, '');  // Rimuovi caratteri speciali
    
    // Inserisci testo processato
    this.value = cleanText;
    
    console.log('üìã Pasted and cleaned:', cleanText);
});

// Paste di immagini
input.addEventListener('paste', function(e) {
    const items = e.clipboardData.items;
    
    for (const item of items) {
        if (item.type.indexOf('image') !== -1) {
            const blob = item.getAsFile();
            const reader = new FileReader();
            
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                container.appendChild(img);
            };
            
            reader.readAsDataURL(blob);
        }
    }
});</div>
            </div>
            <div id="log3" class="log"></div>
        </div>

        <!-- Sezione 4: Drag and Drop -->
        <div class="section">
            <h2>4. Drag and Drop - Trascinamento Elementi</h2>
            <p>Eventi per gestire il drag and drop di elementi.</p>
            
            <div class="demo-area">
                <div class="drag-container">
                    <div class="drop-zone" id="source-zone">
                        <h4>üì¶ Sorgente - Trascina Da Qui</h4>
                        <div class="draggable-item" draggable="true" data-item="item1">
                            üîµ Item 1
                        </div>
                        <div class="draggable-item" draggable="true" data-item="item2">
                            üü¢ Item 2
                        </div>
                        <div class="draggable-item" draggable="true" data-item="item3">
                            üî¥ Item 3
                        </div>
                    </div>
                    
                    <div class="drop-zone" id="target-zone">
                        <h4>üéØ Destinazione - Rilascia Qui</h4>
                    </div>
                </div>
                
                <button onclick="resetDragDemo()">üîÑ Reset</button>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="dragstart-count">0</div>
                        <div class="stat-label">dragstart</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="drop-count">0</div>
                        <div class="stat-label">drop</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dragover-count">0</div>
                        <div class="stat-label">dragover</div>
                    </div>
                </div>
                
                <div class="code-display">
// Drag and Drop completo
let draggedElement = null;

// dragstart - Inizia trascinamento
element.addEventListener('dragstart', function(e) {
    draggedElement = this;
    
    // Imposta dati trasferiti
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
    e.dataTransfer.setData('item-id', this.dataset.itemId);
    
    // Stile visuale
    this.style.opacity = '0.5';
    
    console.log('üéØ Drag started');
});

// dragover - Sopra zona drop (deve preventDefault!)
dropZone.addEventListener('dragover', function(e) {
    e.preventDefault();  // NECESSARIO per permettere drop!
    e.dataTransfer.dropEffect = 'move';
    this.classList.add('drag-over');
});

// dragleave - Lascia zona drop
dropZone.addEventListener('dragleave', function(e) {
    this.classList.remove('drag-over');
});

// drop - Rilasciato
dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Ottieni dati
    const html = e.dataTransfer.getData('text/html');
    const itemId = e.dataTransfer.getData('item-id');
    
    // Sposta elemento
    this.appendChild(draggedElement);
    
    this.classList.remove('drag-over');
    draggedElement.style.opacity = '';
    
    console.log('‚úÖ Dropped:', itemId);
});

// dragend - Fine trascinamento
element.addEventListener('dragend', function(e) {
    this.style.opacity = '';
    console.log('üèÅ Drag ended');
});</div>
            </div>
            <div id="log4" class="log"></div>
        </div>

        <!-- Sezione 5: File Drop -->
        <div class="section">
            <h2>5. File Drop - Caricamento File</h2>
            <p>Drag and drop di file dal file system.</p>
            
            <div class="demo-area">
                <div class="file-drop-zone" id="file-drop-zone">
                    <div style="font-size: 64px; margin-bottom: 20px;">üìÅ</div>
                    <h3>Trascina qui i file</h3>
                    <p style="color: #718096; margin-top: 10px;">oppure clicca per selezionare</p>
                    <input type="file" id="file-input" multiple style="display: none;">
                </div>
                
                <div class="file-list" id="file-list"></div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="files-dropped">0</div>
                        <div class="stat-label">File Caricati</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-size">0</div>
                        <div class="stat-label">Dimensione (KB)</div>
                    </div>
                </div>
                
                <div class="code-display">
// File Drop Zone
const dropZone = document.getElementById('dropZone');

// Previeni comportamento default
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// Highlight zona drop
['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
        dropZone.classList.add('drag-over');
    });
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
        dropZone.classList.remove('drag-over');
    });
});

// Gestisci file droppati
dropZone.addEventListener('drop', function(e) {
    const files = e.dataTransfer.files;
    
    [...files].forEach(file => {
        console.log('File:', file.name);
        console.log('Type:', file.type);
        console.log('Size:', file.size, 'bytes');
        
        // Processa file
        handleFile(file);
    });
});

function handleFile(file) {
    // Se √® immagine, mostra preview
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = document.createElement('img');
            img.src = e.target.result;
            preview.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
    
    // Upload file
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/upload', {
        method: 'POST',
        body: formData
    });
}</div>
            </div>
            <div id="log5" class="log"></div>
        </div>

    </div>

    <script>
        // Utility logging
        function addLog(logId, message) {
            const log = document.getElementById(logId);
            if (!log) return;
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            
            if (log.children.length > 50) {
                log.removeChild(log.firstChild);
            }
        }

        // Sezione 1: storage Event
        let storageEventCount = 0;

        window.addEventListener('storage', function(e) {
            storageEventCount++;
            document.getElementById('storage-event-count').textContent = storageEventCount;
            
            addLog('log1', `üîÑ STORAGE EVENT (da altra tab):`);
            addLog('log1', `   Key: ${e.key}`);
            addLog('log1', `   Old: ${e.oldValue}`);
            addLog('log1', `   New: ${e.newValue}`);
            
            updateStorageDisplay();
        });

        function saveToStorage() {
            const key = document.getElementById('storage-key').value;
            const value = document.getElementById('storage-value').value;
            
            if (key && value) {
                localStorage.setItem(key, value);
                addLog('log1', `üíæ Salvato: ${key} = ${value}`);
                updateStorageDisplay();
            }
        }

        function incrementCounter() {
            const current = parseInt(localStorage.getItem('counter') || '0');
            localStorage.setItem('counter', (current + 1).toString());
            document.getElementById('storage-value').value = current + 1;
            addLog('log1', `‚ûï Counter incrementato: ${current + 1}`);
            updateStorageDisplay();
        }

        function clearStorage() {
            localStorage.clear();
            addLog('log1', 'üóëÔ∏è localStorage cancellato');
            updateStorageDisplay();
        }

        function updateStorageDisplay() {
            const display = document.getElementById('storage-display');
            display.innerHTML = '';
            
            if (localStorage.length === 0) {
                display.innerHTML = '<p style="color: #718096; text-align: center;">Nessun dato salvato</p>';
                document.getElementById('storage-items-count').textContent = '0';
                return;
            }
            
            document.getElementById('storage-items-count').textContent = localStorage.length;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                
                const item = document.createElement('div');
                item.className = 'storage-item';
                item.innerHTML = `
                    <span class="storage-key">${key}</span>
                    <span class="storage-value">${value}</span>
                `;
                display.appendChild(item);
            }
        }

        updateStorageDisplay();
        addLog('log1', 'üí° Apri questa pagina in 2 tab per vedere il sync automatico');
        addLog('log1', '   L\'evento storage si attiva SOLO nelle altre tab!');

        // Sezione 2: copy Event
        let copyCount = 0;

        document.getElementById('attributed-text').addEventListener('copy', function(e) {
            copyCount++;
            document.getElementById('copy-count').textContent = copyCount;
            
            const selection = window.getSelection().toString();
            
            if (selection) {
                e.preventDefault();
                
                const attribution = `\n\n---\nFonte: ${document.title}\nURL: ${location.href}`;
                const modifiedText = selection + attribution;
                
                e.clipboardData.setData('text/plain', modifiedText);
                
                addLog('log2', '‚úÇÔ∏è Testo copiato con attribution');
                addLog('log2', `   Original: ${selection.substring(0, 50)}...`);
            }
        });

        async function copyProgrammatically() {
            const text = 'Questo testo √® stato copiato programmaticamente!';
            
            try {
                await navigator.clipboard.writeText(text);
                addLog('log2', '‚úÖ Copiato negli appunti via Clipboard API');
                addLog('log2', `   Text: ${text}`);
            } catch (err) {
                addLog('log2', '‚ùå Errore copia: ' + err.message);
            }
        }

        addLog('log2', 'üí° Seleziona e copia il testo nella box "Attribution"');
        addLog('log2', '   Verr√† aggiunta automaticamente la fonte!');

        // Sezione 3: paste Event
        let pasteCount = 0;

        document.getElementById('paste-input').addEventListener('paste', function(e) {
            e.preventDefault();
            pasteCount++;
            document.getElementById('paste-count').textContent = pasteCount;
            
            const pastedText = e.clipboardData.getData('text/plain');
            const cleanText = pastedText
                .trim()
                .replace(/\s+/g, ' ')
                .replace(/[^\w\s]/gi, '');
            
            this.value = cleanText;
            
            addLog('log3', `üìã Paste processato:`);
            addLog('log3', `   Original: ${pastedText}`);
            addLog('log3', `   Cleaned: ${cleanText}`);
        });

        document.getElementById('paste-textarea').addEventListener('paste', function(e) {
            e.preventDefault();
            
            const pastedText = e.clipboardData.getData('text/plain');
            const upperText = pastedText.toUpperCase();
            
            this.value = upperText;
            
            addLog('log3', `üìã Paste convertito in MAIUSCOLO`);
        });

        addLog('log3', 'üí° Incolla del testo nei campi per vedere l\'elaborazione');

        // Sezione 4: Drag and Drop
        let dragstartCount = 0;
        let dropCount = 0;
        let dragoverCount = 0;
        let draggedElement = null;
        let dragoverThrottle = 0;

        const draggables = document.querySelectorAll('.draggable-item');
        const dropZones = document.querySelectorAll('.drop-zone');

        draggables.forEach(item => {
            item.addEventListener('dragstart', function(e) {
                draggedElement = this;
                dragstartCount++;
                document.getElementById('dragstart-count').textContent = dragstartCount;
                
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.innerHTML);
                e.dataTransfer.setData('item-id', this.dataset.item);
                
                addLog('log4', `üéØ dragstart: ${this.textContent.trim()}`);
            });

            item.addEventListener('dragend', function(e) {
                this.classList.remove('dragging');
                addLog('log4', `üèÅ dragend: ${this.textContent.trim()}`);
            });
        });

        dropZones.forEach(zone => {
            zone.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                this.classList.add('drag-over');
                
                const now = Date.now();
                if (now - dragoverThrottle > 500) {
                    dragoverThrottle = now;
                    dragoverCount++;
                    document.getElementById('dragover-count').textContent = dragoverCount;
                }
            });

            zone.addEventListener('dragleave', function(e) {
                if (e.target === this) {
                    this.classList.remove('drag-over');
                }
            });

            zone.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (draggedElement) {
                    this.appendChild(draggedElement);
                    dropCount++;
                    document.getElementById('drop-count').textContent = dropCount;
                    
                    addLog('log4', `‚úÖ drop: ${draggedElement.textContent.trim()} ‚Üí ${this.querySelector('h4').textContent}`);
                }
                
                this.classList.remove('drag-over');
            });
        });

        function resetDragDemo() {
            const sourceZone = document.getElementById('source-zone');
            const items = document.querySelectorAll('.draggable-item');
            
            items.forEach(item => {
                sourceZone.appendChild(item);
            });
            
            addLog('log4', 'üîÑ Demo resettata');
        }

        addLog('log4', 'üí° Trascina gli elementi dalla sorgente alla destinazione');

        // Sezione 5: File Drop
        let filesDropped = 0;
        let totalSize = 0;

        const fileDropZone = document.getElementById('file-drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileList = document.getElementById('file-list');

        // Previeni default
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            fileDropZone.addEventListener(eventName, function(e) {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        // Highlight
        ['dragenter', 'dragover'].forEach(eventName => {
            fileDropZone.addEventListener(eventName, function() {
                this.classList.add('drag-over');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            fileDropZone.addEventListener(eventName, function() {
                this.classList.remove('drag-over');
            });
        });

        // Drop files
        fileDropZone.addEventListener('drop', function(e) {
            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        // Click per selezionare
        fileDropZone.addEventListener('click', function() {
            fileInput.click();
        });

        fileInput.addEventListener('change', function(e) {
            handleFiles(this.files);
        });

        function handleFiles(files) {
            [...files].forEach(file => {
                filesDropped++;
                totalSize += file.size;
                
                document.getElementById('files-dropped').textContent = filesDropped;
                document.getElementById('total-size').textContent = Math.round(totalSize / 1024);
                
                const item = document.createElement('div');
                item.className = 'file-item';
                
                const icon = file.type.startsWith('image/') ? 'üñºÔ∏è' : 
                            file.type.startsWith('video/') ? 'üé¨' :
                            file.type.startsWith('audio/') ? 'üéµ' : 'üìÑ';
                
                item.innerHTML = `
                    <div class="file-info">
                        <span style="font-size: 24px;">${icon}</span>
                        <div>
                            <div style="font-weight: bold;">${file.name}</div>
                            <div style="font-size: 12px; color: #718096;">
                                ${(file.size / 1024).toFixed(2)} KB - ${file.type || 'Unknown type'}
                            </div>
                        </div>
                    </div>
                    <button onclick="this.parentElement.remove()" style="padding: 5px 10px; margin: 0;">‚ùå</button>
                `;
                
                fileList.appendChild(item);
                
                addLog('log5', `üìÅ File: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
            });
        }

        addLog('log5', 'üí° Trascina file dal tuo computer nella zona di drop');
        addLog('log5', '   Oppure clicca per selezionare file');
    </script>
</body>
</html>
