<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>05.04 - Sistemi di Particelle</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .section h2 {
            color: #fa709a;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #fee140;
        }

        canvas {
            border: 2px solid #fa709a;
            border-radius: 8px;
            display: block;
            margin: 15px auto;
            background: #111;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: crosshair;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        button {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .info {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #fa709a;
        }

        .info h3 {
            color: #fa709a;
            margin-bottom: 10px;
        }

        .code-display {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin: 15px 0;
        }

        .code-display .keyword { color: #ff79c6; }
        .code-display .function { color: #50fa7b; }
        .code-display .number { color: #bd93f9; }
        .code-display .string { color: #f1fa8c; }
        .code-display .comment { color: #6272a4; }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .stat-box {
            background: linear-gradient(135deg, #fa709a20 0%, #fee14020 100%);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #fa709a;
        }

        .stat-box .label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-box .value {
            font-size: 1.3em;
            font-weight: bold;
            color: #fa709a;
        }

        .slider-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
            min-width: 200px;
        }

        .slider-group label {
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(90deg, #fa709a 0%, #fee140 100%);
            outline: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ú® 05.04 - Sistemi di Particelle</h1>

        <!-- Sezione 1: Particelle Base -->
        <div class="section">
            <h2>‚ö° Particelle Base</h2>
            
            <div class="info">
                <h3>Sistema di Particelle:</h3>
                <p>‚Ä¢ <strong>Emettitore</strong>: genera particelle con propriet√† iniziali</p>
                <p>‚Ä¢ <strong>Particella</strong>: posizione, velocit√†, vita, colore, dimensione</p>
                <p>‚Ä¢ <strong>Aggiornamento</strong>: movimento, invecchiamento, morte</p>
                <p>‚Ä¢ <strong>Rendering</strong>: disegno con trasparenza basata sulla vita</p>
            </div>

            <canvas id="canvas1" width="800" height="400"></canvas>

            <div class="stats">
                <div class="stat-box">
                    <div class="label">Particelle Attive</div>
                    <div class="value" id="count1">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">Particelle/Sec</div>
                    <div class="value" id="rate1">10</div>
                </div>
                <div class="stat-box">
                    <div class="label">FPS</div>
                    <div class="value" id="fps1">60</div>
                </div>
            </div>

            <div class="controls">
                <div class="slider-group">
                    <label>
                        Tasso Emissione: <span id="emissionRate1">10</span>/sec
                    </label>
                    <input type="range" id="emissionSlider1" min="1" max="100" value="10">
                </div>
            </div>

            <div class="controls">
                <button onclick="demo1_fountain()">Fontana</button>
                <button onclick="demo1_explosion()">Esplosione</button>
                <button onclick="demo1_smoke()">Fumo</button>
                <button onclick="demo1_stop()">Stop</button>
            </div>

            <div class="code-display" id="code1"></div>
        </div>

        <!-- Sezione 2: Effetto Fuoco -->
        <div class="section">
            <h2>üî• Effetto Fuoco e Fiamme</h2>
            
            <canvas id="canvas2" width="800" height="400"></canvas>

            <div class="controls">
                <div class="slider-group">
                    <label>
                        Intensit√†: <span id="intensity2">50</span>
                    </label>
                    <input type="range" id="intensitySlider2" min="10" max="200" value="50">
                </div>

                <div class="slider-group">
                    <label>
                        Vento: <span id="wind2">0</span>
                    </label>
                    <input type="range" id="windSlider2" min="-5" max="5" step="0.1" value="0">
                </div>
            </div>

            <div class="controls">
                <button onclick="demo2_campfire()">Fal√≤</button>
                <button onclick="demo2_torch()">Torcia</button>
                <button onclick="demo2_candle()">Candela</button>
                <button onclick="demo2_stop()">Stop</button>
            </div>

            <div class="code-display" id="code2"></div>
        </div>

        <!-- Sezione 3: Gravit√† e Forze -->
        <div class="section">
            <h2>üåç Gravit√† e Forze</h2>
            
            <div class="info">
                <h3>Forze Applicate:</h3>
                <p>‚Ä¢ <strong>Gravit√†</strong>: accelerazione verso il basso</p>
                <p>‚Ä¢ <strong>Vento</strong>: forza orizzontale</p>
                <p>‚Ä¢ <strong>Attrazione</strong>: verso un punto specifico</p>
                <p>‚Ä¢ <strong>Repulsione</strong>: allontanamento da un punto</p>
            </div>

            <canvas id="canvas3" width="800" height="400"></canvas>

            <div class="stats">
                <div class="stat-box">
                    <div class="label">Gravit√†</div>
                    <div class="value" id="gravity3">0.2</div>
                </div>
                <div class="stat-box">
                    <div class="label">Particelle</div>
                    <div class="value" id="count3">0</div>
                </div>
            </div>

            <div class="controls">
                <button onclick="demo3_rain()">Pioggia</button>
                <button onclick="demo3_snow()">Neve</button>
                <button onclick="demo3_confetti()">Coriandoli</button>
                <button onclick="demo3_attractor()">Attrattore</button>
                <button onclick="demo3_stop()">Stop</button>
            </div>

            <div class="code-display" id="code3"></div>
        </div>

        <!-- Sezione 4: Fuochi d'Artificio -->
        <div class="section">
            <h2>üéÜ Fuochi d'Artificio</h2>
            
            <canvas id="canvas4" width="800" height="500"></canvas>

            <div class="stats">
                <div class="stat-box">
                    <div class="label">Razzi Attivi</div>
                    <div class="value" id="rockets4">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">Particelle</div>
                    <div class="value" id="particles4">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">Esplosioni</div>
                    <div class="value" id="explosions4">0</div>
                </div>
            </div>

            <div class="info">
                <p><strong>Clicca sul canvas per lanciare un razzo!</strong></p>
            </div>

            <div class="controls">
                <button onclick="demo4_auto()">Auto</button>
                <button onclick="demo4_manual()">Manuale</button>
                <button onclick="demo4_finale()">Gran Finale</button>
                <button onclick="demo4_stop()">Stop</button>
            </div>

            <div class="code-display" id="code4"></div>
        </div>

        <!-- Sezione 5: Effetti Speciali -->
        <div class="section">
            <h2>üí´ Effetti Speciali</h2>
            
            <canvas id="canvas5" width="800" height="400"></canvas>

            <div class="controls">
                <button onclick="demo5_stars()">Stelle</button>
                <button onclick="demo5_sparkles()">Scintille</button>
                <button onclick="demo5_magic()">Magia</button>
                <button onclick="demo5_portal()">Portale</button>
                <button onclick="demo5_stop()">Stop</button>
            </div>

            <div class="code-display" id="code5"></div>
        </div>

        <!-- Sezione 6: Sistema Complesso -->
        <div class="section">
            <h2>üåå Sistema Complesso Multi-Emettitore</h2>
            
            <canvas id="canvas6" width="800" height="500"></canvas>

            <div class="stats">
                <div class="stat-box">
                    <div class="label">Emettitori</div>
                    <div class="value" id="emitters6">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">Particelle Totali</div>
                    <div class="value" id="totalParticles6">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">FPS</div>
                    <div class="value" id="fps6">60</div>
                </div>
            </div>

            <div class="controls">
                <button onclick="demo6_galaxy()">Galassia</button>
                <button onclick="demo6_nebula()">Nebulosa</button>
                <button onclick="demo6_storm()">Tempesta</button>
                <button onclick="demo6_interactive()">Interattivo</button>
                <button onclick="demo6_stop()">Stop</button>
            </div>

            <div class="info">
                <p><strong>Clicca e trascina in modalit√† interattiva!</strong></p>
            </div>

            <div class="code-display" id="code6"></div>
        </div>
    </div>

    <script>
        // Classe Particella Base
        class Particle {
            constructor(x, y, vx, vy, life, color, size) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.life = life;
                this.maxLife = life;
                this.color = color || '#ffffff';
                this.size = size || 3;
                this.gravity = 0;
            }

            update() {
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;
                this.life--;
            }

            draw(ctx) {
                const alpha = this.life / this.maxLife;
                ctx.globalAlpha = alpha;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, 2 * Math.PI);
                ctx.fill();
                ctx.globalAlpha = 1;
            }

            isDead() {
                return this.life <= 0;
            }
        }

        // ======================
        // SEZIONE 1: Particelle Base
        // ======================
        const canvas1 = document.getElementById('canvas1');
        const ctx1 = canvas1.getContext('2d');

        let anim1 = null;
        let particles1 = [];
        let emitter1 = { x: 400, y: 400, rate: 10 };
        let mode1 = 'fountain';
        let lastTime1 = 0;
        let frameCount1 = 0;
        let lastFpsTime1 = 0;

        const emissionSlider1 = document.getElementById('emissionSlider1');
        emissionSlider1.oninput = () => {
            emitter1.rate = parseInt(emissionSlider1.value);
            document.getElementById('emissionRate1').textContent = emitter1.rate;
            document.getElementById('rate1').textContent = emitter1.rate;
        };

        function demo1_fountain() {
            mode1 = 'fountain';
            emitter1 = { x: 400, y: 400, rate: 10 };
            particles1 = [];
            if (!anim1) animate1();
        }

        function demo1_explosion() {
            mode1 = 'explosion';
            particles1 = [];
            
            // Create explosion
            for (let i = 0; i < 100; i++) {
                const angle = (Math.PI * 2 * i) / 100;
                const speed = 2 + Math.random() * 5;
                particles1.push(new Particle(
                    400, 200,
                    Math.cos(angle) * speed,
                    Math.sin(angle) * speed,
                    60 + Math.random() * 40,
                    `hsl(${Math.random() * 60 + 10}, 100%, 60%)`,
                    2 + Math.random() * 3
                ));
                particles1[particles1.length - 1].gravity = 0.1;
            }
            
            if (!anim1) animate1();
        }

        function demo1_smoke() {
            mode1 = 'smoke';
            emitter1 = { x: 400, y: 400, rate: 5 };
            particles1 = [];
            if (!anim1) animate1();
        }

        function animate1(timestamp = 0) {
            const deltaTime = timestamp - lastTime1;
            lastTime1 = timestamp;

            ctx1.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx1.fillRect(0, 0, canvas1.width, canvas1.height);

            // Emit particles
            if (mode1 === 'fountain' || mode1 === 'smoke') {
                const particlesToEmit = Math.floor(emitter1.rate / 60);
                for (let i = 0; i < particlesToEmit; i++) {
                    if (mode1 === 'fountain') {
                        const angle = -Math.PI / 2 + (Math.random() - 0.5) * 0.5;
                        const speed = 5 + Math.random() * 3;
                        const p = new Particle(
                            emitter1.x, emitter1.y,
                            Math.cos(angle) * speed,
                            Math.sin(angle) * speed,
                            80,
                            `hsl(${200 + Math.random() * 40}, 70%, 60%)`,
                            2 + Math.random() * 2
                        );
                        p.gravity = 0.2;
                        particles1.push(p);
                    } else if (mode1 === 'smoke') {
                        const p = new Particle(
                            emitter1.x + (Math.random() - 0.5) * 20,
                            emitter1.y,
                            (Math.random() - 0.5) * 2,
                            -1 - Math.random() * 2,
                            100,
                            `rgba(${150 + Math.random() * 50}, ${150 + Math.random() * 50}, ${150 + Math.random() * 50}, 0.5)`,
                            5 + Math.random() * 10
                        );
                        particles1.push(p);
                    }
                }
            }

            // Update and draw
            particles1 = particles1.filter(p => {
                p.update();
                p.draw(ctx1);
                return !p.isDead();
            });

            document.getElementById('count1').textContent = particles1.length;

            // FPS counter
            frameCount1++;
            if (timestamp - lastFpsTime1 > 1000) {
                document.getElementById('fps1').textContent = frameCount1;
                frameCount1 = 0;
                lastFpsTime1 = timestamp;
            }

            anim1 = requestAnimationFrame(animate1);

            document.getElementById('code1').innerHTML = `
<span class="keyword">class</span> <span class="function">Particle</span> {<br>
&nbsp;&nbsp;<span class="function">constructor</span>(x, y, vx, vy, life) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">this</span>.x = x;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">this</span>.vx = vx;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">this</span>.life = life;<br>
&nbsp;&nbsp;}<br>
&nbsp;&nbsp;<span class="function">update</span>() {<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">this</span>.x += <span class="keyword">this</span>.vx;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">this</span>.life--;<br>
&nbsp;&nbsp;}<br>
}
            `;
        }

        function demo1_stop() {
            if (anim1) cancelAnimationFrame(anim1);
            anim1 = null;
        }

        demo1_fountain();

        // ======================
        // SEZIONE 2: Fuoco
        // ======================
        const canvas2 = document.getElementById('canvas2');
        const ctx2 = canvas2.getContext('2d');

        let anim2 = null;
        let particles2 = [];
        let intensity2 = 50;
        let wind2 = 0;
        let mode2 = 'campfire';

        const intensitySlider2 = document.getElementById('intensitySlider2');
        const windSlider2 = document.getElementById('windSlider2');

        intensitySlider2.oninput = () => {
            intensity2 = parseInt(intensitySlider2.value);
            document.getElementById('intensity2').textContent = intensity2;
        };

        windSlider2.oninput = () => {
            wind2 = parseFloat(windSlider2.value);
            document.getElementById('wind2').textContent = wind2.toFixed(1);
        };

        function demo2_campfire() {
            mode2 = 'campfire';
            particles2 = [];
            if (!anim2) animate2();
        }

        function demo2_torch() {
            mode2 = 'torch';
            particles2 = [];
            if (!anim2) animate2();
        }

        function demo2_candle() {
            mode2 = 'candle';
            particles2 = [];
            if (!anim2) animate2();
        }

        function animate2() {
            ctx2.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx2.fillRect(0, 0, canvas2.width, canvas2.height);

            // Emit fire particles
            const emitRate = Math.floor(intensity2 / 10);
            for (let i = 0; i < emitRate; i++) {
                let x, y, baseVy;
                
                if (mode2 === 'campfire') {
                    x = 400 + (Math.random() - 0.5) * 100;
                    y = 350;
                    baseVy = -3 - Math.random() * 2;
                } else if (mode2 === 'torch') {
                    x = 400 + (Math.random() - 0.5) * 30;
                    y = 300;
                    baseVy = -4 - Math.random() * 2;
                } else if (mode2 === 'candle') {
                    x = 400 + (Math.random() - 0.5) * 10;
                    y = 250;
                    baseVy = -2 - Math.random();
                }

                // Color gradient: red -> orange -> yellow
                const t = Math.random();
                let color;
                if (t < 0.33) {
                    color = `rgba(255, ${Math.floor(50 + t * 300)}, 0, ${0.8 + Math.random() * 0.2})`;
                } else if (t < 0.66) {
                    color = `rgba(255, ${Math.floor(150 + (t - 0.33) * 300)}, 0, ${0.6 + Math.random() * 0.2})`;
                } else {
                    color = `rgba(255, 255, ${Math.floor((t - 0.66) * 500)}, ${0.4 + Math.random() * 0.2})`;
                }

                const p = new Particle(
                    x, y,
                    (Math.random() - 0.5) * 0.5 + wind2 * 0.1,
                    baseVy,
                    30 + Math.random() * 30,
                    color,
                    3 + Math.random() * 4
                );
                particles2.push(p);
            }

            // Update and draw
            particles2 = particles2.filter(p => {
                p.vx += wind2 * 0.01;
                p.update();
                p.draw(ctx2);
                return !p.isDead();
            });

            anim2 = requestAnimationFrame(animate2);

            document.getElementById('code2').innerHTML = `
<span class="comment">// Fire particle color gradient</span><br>
<span class="keyword">const</span> t = Math.random();<br>
<span class="keyword">let</span> color;<br>
<span class="keyword">if</span> (t < <span class="number">0.33</span>) {<br>
&nbsp;&nbsp;color = <span class="string">'red'</span>;<br>
} <span class="keyword">else if</span> (t < <span class="number">0.66</span>) {<br>
&nbsp;&nbsp;color = <span class="string">'orange'</span>;<br>
} <span class="keyword">else</span> {<br>
&nbsp;&nbsp;color = <span class="string">'yellow'</span>;<br>
}
            `;
        }

        function demo2_stop() {
            if (anim2) cancelAnimationFrame(anim2);
            anim2 = null;
        }

        demo2_campfire();

        // ======================
        // SEZIONE 3: Gravit√†
        // ======================
        const canvas3 = document.getElementById('canvas3');
        const ctx3 = canvas3.getContext('2d');

        let anim3 = null;
        let particles3 = [];
        let mode3 = 'rain';
        let attractor3 = { x: 400, y: 200 };

        canvas3.addEventListener('mousemove', (e) => {
            const rect = canvas3.getBoundingClientRect();
            attractor3.x = e.clientX - rect.left;
            attractor3.y = e.clientY - rect.top;
        });

        function demo3_rain() {
            mode3 = 'rain';
            particles3 = [];
            if (!anim3) animate3();
            document.getElementById('gravity3').textContent = '0.5';
        }

        function demo3_snow() {
            mode3 = 'snow';
            particles3 = [];
            if (!anim3) animate3();
            document.getElementById('gravity3').textContent = '0.1';
        }

        function demo3_confetti() {
            mode3 = 'confetti';
            particles3 = [];
            
            // Create confetti burst
            for (let i = 0; i < 200; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 8;
                const p = new Particle(
                    400, 50,
                    Math.cos(angle) * speed,
                    Math.sin(angle) * speed - 5,
                    100 + Math.random() * 100,
                    `hsl(${Math.random() * 360}, 100%, 60%)`,
                    3 + Math.random() * 3
                );
                p.gravity = 0.15;
                p.rotation = Math.random() * Math.PI * 2;
                p.rotationSpeed = (Math.random() - 0.5) * 0.2;
                particles3.push(p);
            }
            
            if (!anim3) animate3();
            document.getElementById('gravity3').textContent = '0.15';
        }

        function demo3_attractor() {
            mode3 = 'attractor';
            particles3 = [];
            if (!anim3) animate3();
            document.getElementById('gravity3').textContent = 'var';
        }

        function animate3() {
            ctx3.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx3.fillRect(0, 0, canvas3.width, canvas3.height);

            // Emit particles
            if (mode3 === 'rain') {
                if (Math.random() < 0.5) {
                    const p = new Particle(
                        Math.random() * canvas3.width,
                        0,
                        0,
                        5 + Math.random() * 5,
                        100,
                        'rgba(100, 150, 255, 0.6)',
                        1 + Math.random()
                    );
                    p.gravity = 0.5;
                    particles3.push(p);
                }
            } else if (mode3 === 'snow') {
                if (Math.random() < 0.3) {
                    const p = new Particle(
                        Math.random() * canvas3.width,
                        0,
                        (Math.random() - 0.5) * 2,
                        1 + Math.random(),
                        200,
                        'rgba(255, 255, 255, 0.8)',
                        2 + Math.random() * 3
                    );
                    p.gravity = 0.05;
                    particles3.push(p);
                }
            } else if (mode3 === 'attractor') {
                if (Math.random() < 0.2) {
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 200 + Math.random() * 200;
                    const p = new Particle(
                        attractor3.x + Math.cos(angle) * distance,
                        attractor3.y + Math.sin(angle) * distance,
                        0, 0,
                        150,
                        `hsl(${Math.random() * 360}, 70%, 60%)`,
                        2 + Math.random() * 2
                    );
                    particles3.push(p);
                }

                // Draw attractor
                ctx3.fillStyle = 'rgba(255, 100, 100, 0.5)';
                ctx3.beginPath();
                ctx3.arc(attractor3.x, attractor3.y, 10, 0, 2 * Math.PI);
                ctx3.fill();
            }

            // Update
            particles3 = particles3.filter(p => {
                if (mode3 === 'attractor') {
                    const dx = attractor3.x - p.x;
                    const dy = attractor3.y - p.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const force = 100 / (distance * distance);
                    p.vx += (dx / distance) * force;
                    p.vy += (dy / distance) * force;
                }

                if (p.rotationSpeed) {
                    p.rotation += p.rotationSpeed;
                }

                p.update();

                // Draw with rotation
                if (p.rotation !== undefined) {
                    ctx3.save();
                    ctx3.translate(p.x, p.y);
                    ctx3.rotate(p.rotation);
                    ctx3.globalAlpha = p.life / p.maxLife;
                    ctx3.fillStyle = p.color;
                    ctx3.fillRect(-p.size, -p.size / 2, p.size * 2, p.size);
                    ctx3.restore();
                    ctx3.globalAlpha = 1;
                } else {
                    p.draw(ctx3);
                }

                return !p.isDead() && p.y < canvas3.height + 10;
            });

            document.getElementById('count3').textContent = particles3.length;

            anim3 = requestAnimationFrame(animate3);

            document.getElementById('code3').innerHTML = `
<span class="comment">// Apply attraction force</span><br>
<span class="keyword">const</span> dx = target.x - particle.x;<br>
<span class="keyword">const</span> dy = target.y - particle.y;<br>
<span class="keyword">const</span> distance = Math.sqrt(dx*dx + dy*dy);<br>
<span class="keyword">const</span> force = <span class="number">100</span> / (distance * distance);<br>
particle.vx += (dx / distance) * force;
            `;
        }

        function demo3_stop() {
            if (anim3) cancelAnimationFrame(anim3);
            anim3 = null;
        }

        demo3_rain();

        // ======================
        // SEZIONE 4: Fuochi d'Artificio
        // ======================
        const canvas4 = document.getElementById('canvas4');
        const ctx4 = canvas4.getContext('2d');

        let anim4 = null;
        let rockets4 = [];
        let particles4 = [];
        let mode4 = 'manual';
        let explosionCount4 = 0;

        canvas4.addEventListener('click', (e) => {
            if (mode4 === 'manual') {
                const rect = canvas4.getBoundingClientRect();
                launchRocket4(e.clientX - rect.left, e.clientY - rect.top);
            }
        });

        function launchRocket4(targetX, targetY) {
            rockets4.push({
                x: canvas4.width / 2,
                y: canvas4.height,
                targetX: targetX,
                targetY: targetY,
                vx: (targetX - canvas4.width / 2) * 0.02,
                vy: -10,
                life: 100,
                trail: []
            });
        }

        function demo4_auto() {
            mode4 = 'auto';
            rockets4 = [];
            particles4 = [];
            if (!anim4) animate4();
        }

        function demo4_manual() {
            mode4 = 'manual';
            rockets4 = [];
            particles4 = [];
            if (!anim4) animate4();
        }

        function demo4_finale() {
            mode4 = 'finale';
            rockets4 = [];
            particles4 = [];
            
            // Launch multiple rockets
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    launchRocket4(
                        100 + Math.random() * 600,
                        100 + Math.random() * 200
                    );
                }, i * 200);
            }
            
            if (!anim4) animate4();
        }

        function animate4() {
            ctx4.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx4.fillRect(0, 0, canvas4.width, canvas4.height);

            // Auto mode
            if (mode4 === 'auto' && Math.random() < 0.02) {
                launchRocket4(
                    100 + Math.random() * 600,
                    50 + Math.random() * 150
                );
            }

            // Update rockets
            rockets4 = rockets4.filter(r => {
                r.x += r.vx;
                r.y += r.vy;
                r.vy += 0.1; // Gravity
                r.life--;

                // Trail
                r.trail.push({ x: r.x, y: r.y, life: 20 });
                r.trail = r.trail.filter(t => {
                    t.life--;
                    const alpha = t.life / 20;
                    ctx4.fillStyle = `rgba(255, 200, 100, ${alpha})`;
                    ctx4.beginPath();
                    ctx4.arc(t.x, t.y, 2, 0, 2 * Math.PI);
                    ctx4.fill();
                    return t.life > 0;
                });

                // Draw rocket
                ctx4.fillStyle = '#fff';
                ctx4.beginPath();
                ctx4.arc(r.x, r.y, 3, 0, 2 * Math.PI);
                ctx4.fill();

                // Explode when near target or time out
                const distToTarget = Math.sqrt((r.x - r.targetX) ** 2 + (r.y - r.targetY) ** 2);
                if (distToTarget < 20 || r.life <= 0) {
                    explode4(r.x, r.y);
                    return false;
                }

                return true;
            });

            // Update particles
            particles4 = particles4.filter(p => {
                p.update();
                p.draw(ctx4);
                return !p.isDead();
            });

            document.getElementById('rockets4').textContent = rockets4.length;
            document.getElementById('particles4').textContent = particles4.length;
            document.getElementById('explosions4').textContent = explosionCount4;

            anim4 = requestAnimationFrame(animate4);

            document.getElementById('code4').innerHTML = `
<span class="comment">// Firework explosion</span><br>
<span class="keyword">function</span> <span class="function">explode</span>(x, y) {<br>
&nbsp;&nbsp;<span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i < <span class="number">100</span>; i++) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> angle = (i * <span class="number">2</span> * Math.PI) / <span class="number">100</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">const</span> speed = <span class="number">2</span> + Math.random() * <span class="number">5</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;createParticle(x, y, angle, speed);<br>
&nbsp;&nbsp;}<br>
}
            `;
        }

        function explode4(x, y) {
            explosionCount4++;
            const color = Math.random() * 360;
            const particleCount = 50 + Math.random() * 100;

            for (let i = 0; i < particleCount; i++) {
                const angle = (Math.PI * 2 * i) / particleCount;
                const speed = 1 + Math.random() * 6;
                const p = new Particle(
                    x, y,
                    Math.cos(angle) * speed,
                    Math.sin(angle) * speed,
                    40 + Math.random() * 40,
                    `hsl(${color + Math.random() * 30}, 100%, ${50 + Math.random() * 30}%)`,
                    2 + Math.random() * 2
                );
                p.gravity = 0.15;
                particles4.push(p);
            }
        }

        function demo4_stop() {
            if (anim4) cancelAnimationFrame(anim4);
            anim4 = null;
        }

        demo4_manual();

        // ======================
        // SEZIONE 5: Effetti Speciali
        // ======================
        const canvas5 = document.getElementById('canvas5');
        const ctx5 = canvas5.getContext('2d');

        let anim5 = null;
        let particles5 = [];
        let mode5 = 'stars';

        function demo5_stars() {
            mode5 = 'stars';
            particles5 = [];
            
            // Create starfield
            for (let i = 0; i < 200; i++) {
                particles5.push({
                    x: Math.random() * canvas5.width,
                    y: Math.random() * canvas5.height,
                    z: Math.random() * 1000,
                    size: 1 + Math.random() * 2
                });
            }
            
            if (!anim5) animate5();
        }

        function demo5_sparkles() {
            mode5 = 'sparkles';
            particles5 = [];
            if (!anim5) animate5();
        }

        function demo5_magic() {
            mode5 = 'magic';
            particles5 = [];
            if (!anim5) animate5();
        }

        function demo5_portal() {
            mode5 = 'portal';
            particles5 = [];
            if (!anim5) animate5();
        }

        function animate5() {
            ctx5.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx5.fillRect(0, 0, canvas5.width, canvas5.height);

            if (mode5 === 'stars') {
                particles5.forEach(p => {
                    p.z -= 5;
                    if (p.z <= 0) p.z = 1000;

                    const x = (p.x - canvas5.width / 2) * (1000 / p.z) + canvas5.width / 2;
                    const y = (p.y - canvas5.height / 2) * (1000 / p.z) + canvas5.height / 2;
                    const size = p.size * (1000 / p.z) * 0.5;

                    ctx5.fillStyle = '#fff';
                    ctx5.beginPath();
                    ctx5.arc(x, y, size, 0, 2 * Math.PI);
                    ctx5.fill();
                });
            } else if (mode5 === 'sparkles') {
                if (Math.random() < 0.5) {
                    particles5.push({
                        x: Math.random() * canvas5.width,
                        y: Math.random() * canvas5.height,
                        size: 2 + Math.random() * 4,
                        life: 30,
                        points: 4 + Math.floor(Math.random() * 4)
                    });
                }

                particles5 = particles5.filter(p => {
                    p.life--;
                    const alpha = p.life / 30;
                    
                    ctx5.save();
                    ctx5.translate(p.x, p.y);
                    ctx5.globalAlpha = alpha;
                    
                    // Draw star
                    ctx5.fillStyle = `hsl(${(p.life * 12) % 360}, 100%, 70%)`;
                    ctx5.beginPath();
                    for (let i = 0; i < p.points * 2; i++) {
                        const angle = (Math.PI * i) / p.points;
                        const radius = i % 2 === 0 ? p.size : p.size / 2;
                        const x = Math.cos(angle) * radius;
                        const y = Math.sin(angle) * radius;
                        if (i === 0) ctx5.moveTo(x, y);
                        else ctx5.lineTo(x, y);
                    }
                    ctx5.closePath();
                    ctx5.fill();
                    
                    ctx5.restore();
                    
                    return p.life > 0;
                });
            } else if (mode5 === 'magic') {
                for (let i = 0; i < 5; i++) {
                    const angle = Date.now() * 0.001 + i * (Math.PI * 2 / 5);
                    const radius = 100 + Math.sin(Date.now() * 0.003) * 20;
                    particles5.push({
                        x: canvas5.width / 2 + Math.cos(angle) * radius,
                        y: canvas5.height / 2 + Math.sin(angle) * radius,
                        vx: Math.cos(angle) * 0.5,
                        vy: Math.sin(angle) * 0.5,
                        life: 50,
                        color: `hsl(${(i * 72 + Date.now() * 0.1) % 360}, 100%, 60%)`,
                        size: 3
                    });
                }

                particles5 = particles5.filter(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life--;
                    
                    const alpha = p.life / 50;
                    ctx5.globalAlpha = alpha;
                    ctx5.fillStyle = p.color;
                    ctx5.beginPath();
                    ctx5.arc(p.x, p.y, p.size, 0, 2 * Math.PI);
                    ctx5.fill();
                    ctx5.globalAlpha = 1;
                    
                    return p.life > 0;
                });
            } else if (mode5 === 'portal') {
                for (let i = 0; i < 3; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const radius = Math.random() * 150;
                    particles5.push({
                        x: canvas5.width / 2 + Math.cos(angle) * radius,
                        y: canvas5.height / 2 + Math.sin(angle) * radius,
                        angle: angle,
                        radius: radius,
                        speed: 2 + Math.random() * 3,
                        life: 100,
                        color: `hsl(${180 + Math.random() * 60}, 100%, 60%)`,
                        size: 2 + Math.random() * 2
                    });
                }

                particles5 = particles5.filter(p => {
                    p.angle += p.speed * 0.01;
                    p.radius -= 1;
                    p.x = canvas5.width / 2 + Math.cos(p.angle) * p.radius;
                    p.y = canvas5.height / 2 + Math.sin(p.angle) * p.radius;
                    p.life--;
                    
                    const alpha = Math.min(1, p.life / 50);
                    ctx5.globalAlpha = alpha;
                    ctx5.fillStyle = p.color;
                    ctx5.beginPath();
                    ctx5.arc(p.x, p.y, p.size, 0, 2 * Math.PI);
                    ctx5.fill();
                    ctx5.globalAlpha = 1;
                    
                    return p.life > 0 && p.radius > 0;
                });
            }

            anim5 = requestAnimationFrame(animate5);

            document.getElementById('code5').innerHTML = `
<span class="comment">// Mode: ${mode5}</span>
            `;
        }

        function demo5_stop() {
            if (anim5) cancelAnimationFrame(anim5);
            anim5 = null;
        }

        demo5_stars();

        // ======================
        // SEZIONE 6: Multi-Emettitore
        // ======================
        const canvas6 = document.getElementById('canvas6');
        const ctx6 = canvas6.getContext('2d');

        let anim6 = null;
        let emitters6 = [];
        let allParticles6 = [];
        let mode6 = 'galaxy';
        let frameCount6 = 0;
        let lastFpsTime6 = 0;

        canvas6.addEventListener('mousedown', (e) => {
            if (mode6 === 'interactive') {
                const rect = canvas6.getBoundingClientRect();
                emitters6.push({
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top,
                    rate: 20,
                    life: 200
                });
            }
        });

        function demo6_galaxy() {
            mode6 = 'galaxy';
            emitters6 = [];
            allParticles6 = [];
            
            // Create spiral galaxy emitters
            for (let i = 0; i < 3; i++) {
                emitters6.push({
                    angle: (i * Math.PI * 2) / 3,
                    distance: 0,
                    speed: 0.02,
                    rate: 15
                });
            }
            
            if (!anim6) animate6();
        }

        function demo6_nebula() {
            mode6 = 'nebula';
            emitters6 = [];
            allParticles6 = [];
            
            // Create multiple emitters
            for (let i = 0; i < 5; i++) {
                emitters6.push({
                    x: 200 + i * 100,
                    y: 250,
                    rate: 10,
                    color: Math.random() * 360
                });
            }
            
            if (!anim6) animate6();
        }

        function demo6_storm() {
            mode6 = 'storm';
            emitters6 = [];
            allParticles6 = [];
            if (!anim6) animate6();
        }

        function demo6_interactive() {
            mode6 = 'interactive';
            emitters6 = [];
            allParticles6 = [];
            if (!anim6) animate6();
        }

        function animate6(timestamp = 0) {
            ctx6.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx6.fillRect(0, 0, canvas6.width, canvas6.height);

            if (mode6 === 'galaxy') {
                emitters6.forEach(e => {
                    e.angle += e.speed;
                    e.distance += 0.5;
                    if (e.distance > 200) e.distance = 0;

                    const x = canvas6.width / 2 + Math.cos(e.angle) * e.distance;
                    const y = canvas6.height / 2 + Math.sin(e.angle) * e.distance;

                    for (let i = 0; i < e.rate / 60; i++) {
                        const p = new Particle(
                            x, y,
                            (Math.random() - 0.5) * 0.5,
                            (Math.random() - 0.5) * 0.5,
                            150,
                            `hsl(${200 + Math.random() * 80}, 70%, 60%)`,
                            1 + Math.random() * 2
                        );
                        allParticles6.push(p);
                    }
                });
            } else if (mode6 === 'nebula') {
                emitters6.forEach(e => {
                    for (let i = 0; i < e.rate / 60; i++) {
                        const angle = Math.random() * Math.PI * 2;
                        const speed = Math.random() * 2;
                        const p = new Particle(
                            e.x, e.y,
                            Math.cos(angle) * speed,
                            Math.sin(angle) * speed,
                            200,
                            `hsl(${e.color + Math.random() * 30}, 70%, 60%)`,
                            2 + Math.random() * 4
                        );
                        allParticles6.push(p);
                    }
                });
            } else if (mode6 === 'storm') {
                // Lightning
                if (Math.random() < 0.02) {
                    const x = Math.random() * canvas6.width;
                    for (let i = 0; i < 50; i++) {
                        const p = new Particle(
                            x + (Math.random() - 0.5) * 100,
                            Math.random() * canvas6.height,
                            0, 0,
                            10 + Math.random() * 10,
                            'rgba(200, 220, 255, 0.8)',
                            3 + Math.random() * 5
                        );
                        allParticles6.push(p);
                    }
                }

                // Rain
                for (let i = 0; i < 5; i++) {
                    const p = new Particle(
                        Math.random() * canvas6.width,
                        0,
                        (Math.random() - 0.5) * 2,
                        5 + Math.random() * 5,
                        100,
                        'rgba(150, 180, 255, 0.3)',
                        1
                    );
                    p.gravity = 0.3;
                    allParticles6.push(p);
                }
            } else if (mode6 === 'interactive') {
                emitters6 = emitters6.filter(e => {
                    for (let i = 0; i < e.rate / 60; i++) {
                        const angle = Math.random() * Math.PI * 2;
                        const speed = 1 + Math.random() * 3;
                        const p = new Particle(
                            e.x, e.y,
                            Math.cos(angle) * speed,
                            Math.sin(angle) * speed,
                            60,
                            `hsl(${Math.random() * 360}, 100%, 60%)`,
                            2 + Math.random() * 3
                        );
                        allParticles6.push(p);
                    }

                    e.life--;
                    return e.life > 0;
                });
            }

            // Update all particles
            allParticles6 = allParticles6.filter(p => {
                p.update();
                p.draw(ctx6);
                return !p.isDead();
            });

            document.getElementById('emitters6').textContent = emitters6.length;
            document.getElementById('totalParticles6').textContent = allParticles6.length;

            // FPS
            frameCount6++;
            if (timestamp - lastFpsTime6 > 1000) {
                document.getElementById('fps6').textContent = frameCount6;
                frameCount6 = 0;
                lastFpsTime6 = timestamp;
            }

            anim6 = requestAnimationFrame(animate6);

            document.getElementById('code6').innerHTML = `
<span class="comment">// Multi-emitter system</span><br>
emitters.<span class="function">forEach</span>(e => {<br>
&nbsp;&nbsp;<span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i < e.rate; i++) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;createParticle(e.x, e.y);<br>
&nbsp;&nbsp;}<br>
});
            `;
        }

        function demo6_stop() {
            if (anim6) cancelAnimationFrame(anim6);
            anim6 = null;
        }

        demo6_galaxy();
    </script>
</body>
</html>