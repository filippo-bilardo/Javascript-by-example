<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>01.05 - Save e Restore dello Stato</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            color: rgba(255,255,255,0.9);
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section h2::before {
            content: 'üíæ';
        }

        canvas {
            border: 3px solid #667eea;
            border-radius: 10px;
            display: block;
            margin: 20px auto;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .info-box strong {
            color: #1976D2;
        }

        .info-box code {
            background: #bbdefb;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .warning-box strong {
            color: #f57c00;
        }

        .code-display {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }

        .code-display .comment { color: #6a9955; }
        .code-display .keyword { color: #569cd6; }
        .code-display .string { color: #ce9178; }
        .code-display .function { color: #dcdcaa; }
        .code-display .number { color: #b5cea8; }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            margin: 5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .stack-visual {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .stack-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            margin: 5px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s;
        }

        .stack-item.active {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.6);
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .comparison-item {
            text-align: center;
        }

        .comparison-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .state-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .state-info .property {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .state-info .property:last-child {
            border-bottom: none;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíæ Save e Restore dello Stato Canvas</h1>
        <p class="subtitle">Gestisci lo stack degli stati per modifiche temporanee</p>

        <!-- Sezione 1: Concetto Base -->
        <div class="section">
            <h2>1. Concetto di Save/Restore</h2>
            
            <div class="info-box">
                <strong>üìå Stack degli Stati:</strong> Canvas mantiene uno stack (pila) di stati.
                <br><code>save()</code> ‚Üí salva lo stato corrente nello stack
                <br><code>restore()</code> ‚Üí ripristina l'ultimo stato salvato
            </div>

            <canvas id="canvas1" width="600" height="300"></canvas>

            <div class="code-display">
<span class="comment">// Stato iniziale</span>
ctx.fillStyle = <span class="string">'blue'</span>;

<span class="comment">// Salva stato 1 (fillStyle = 'blue')</span>
ctx.<span class="function">save</span>();

<span class="comment">// Cambia colore</span>
ctx.fillStyle = <span class="string">'red'</span>;
ctx.<span class="function">fillRect</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">50</span>); <span class="comment">// Rosso</span>

<span class="comment">// Ripristina stato 1</span>
ctx.<span class="function">restore</span>();

<span class="comment">// Ora fillStyle √® di nuovo 'blue'!</span>
ctx.<span class="function">fillRect</span>(<span class="number">70</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">50</span>); <span class="comment">// Blu</span>
            </div>

            <div class="controls">
                <button onclick="demoBasic()">üîµ Demo Base</button>
                <button onclick="clearCanvas1()">üóëÔ∏è Cancella</button>
            </div>
        </div>

        <!-- Sezione 2: Stack Visuale -->
        <div class="section">
            <h2>2. Visualizzazione dello Stack</h2>
            
            <div class="info-box">
                <strong>üìå Come Funziona:</strong> Ogni <code>save()</code> aggiunge uno stato allo stack.
                <br>Ogni <code>restore()</code> rimuove (e ripristina) l'ultimo stato salvato.
            </div>

            <div class="stack-visual" id="stackVisual">
                <div style="text-align: center; color: #666; margin-bottom: 15px;">
                    <strong>STACK (LIFO - Last In, First Out)</strong>
                </div>
                <div id="stackItems"></div>
            </div>

            <div class="controls">
                <button onclick="pushState()">‚¨ÜÔ∏è save() - Salva Stato</button>
                <button onclick="popState()">‚¨áÔ∏è restore() - Ripristina Stato</button>
                <button onclick="resetStack()">üîÑ Reset Stack</button>
            </div>

            <div class="code-display">
<span class="comment">// Stack inizia vuoto</span>
ctx.fillStyle = <span class="string">'red'</span>; <span class="comment">// Stato 0 (base)</span>

ctx.<span class="function">save</span>();              <span class="comment">// Stack: [stato 0]</span>
ctx.fillStyle = <span class="string">'blue'</span>;    <span class="comment">// Stato 1</span>

ctx.<span class="function">save</span>();              <span class="comment">// Stack: [stato 0, stato 1]</span>
ctx.fillStyle = <span class="string">'green'</span>;   <span class="comment">// Stato 2</span>

ctx.<span class="function">restore</span>();           <span class="comment">// Ripristina stato 1 (blue)</span>
                           <span class="comment">// Stack: [stato 0]</span>

ctx.<span class="function">restore</span>();           <span class="comment">// Ripristina stato 0 (red)</span>
                           <span class="comment">// Stack: []</span>
            </div>
        </div>

        <!-- Sezione 3: Cosa Viene Salvato -->
        <div class="section">
            <h2>3. Propriet√† Salvate da save()</h2>
            
            <div class="info-box">
                <strong>üìå Stato Completo:</strong> <code>save()</code> salva TUTTE queste propriet√†:
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0;">
                <div class="state-info">
                    <strong>üé® Stili</strong>
                    <div class="property">
                        <span>fillStyle</span>
                        <span>‚úì</span>
                    </div>
                    <div class="property">
                        <span>strokeStyle</span>
                        <span>‚úì</span>
                    </div>
                    <div class="property">
                        <span>globalAlpha</span>
                        <span>‚úì</span>
                    </div>
                </div>

                <div class="state-info">
                    <strong>üìè Linee</strong>
                    <div class="property">
                        <span>lineWidth</span>
                        <span>‚úì</span>
                    </div>
                    <div class="property">
                        <span>lineCap</span>
                        <span>‚úì</span>
                    </div>
                    <div class="property">
                        <span>lineJoin</span>
                        <span>‚úì</span>
                    </div>
                </div>

                <div class="state-info">
                    <strong>‚úÇÔ∏è Clipping</strong>
                    <div class="property">
                        <span>clip region</span>
                        <span>‚úì</span>
                    </div>
                    <div class="property">
                        <span>shadowBlur</span>
                        <span>‚úì</span>
                    </div>
                    <div class="property">
                        <span>shadowColor</span>
                        <span>‚úì</span>
                    </div>
                </div>

                <div class="state-info">
                    <strong>üîÑ Trasformazioni</strong>
                    <div class="property">
                        <span>translate</span>
                        <span>‚úì</span>
                    </div>
                    <div class="property">
                        <span>rotate</span>
                        <span>‚úì</span>
                    </div>
                    <div class="property">
                        <span>scale</span>
                        <span>‚úì</span>
                    </div>
                </div>
            </div>

            <div class="warning-box">
                <strong>‚ö†Ô∏è NON Salvato:</strong> Il contenuto del canvas (i pixel disegnati) NON viene salvato!
                <br>Solo le propriet√† di stile e trasformazione vengono salvate.
            </div>
        </div>

        <!-- Sezione 4: Uso Pratico -->
        <div class="section">
            <h2>4. Esempio Pratico: Disegno Temporaneo</h2>
            
            <canvas id="canvas2" width="600" height="400"></canvas>

            <div class="code-display">
<span class="comment">// Stile principale dell'app</span>
ctx.fillStyle = <span class="string">'#667eea'</span>;
ctx.lineWidth = <span class="number">2</span>;

<span class="comment">// Disegna sfondo normale</span>
ctx.<span class="function">fillRect</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">600</span>, <span class="number">400</span>);

<span class="comment">// ‚≠ê SALVA lo stato prima di modifiche temporanee</span>
ctx.<span class="function">save</span>();

<span class="comment">// Modifiche temporanee per highlight</span>
ctx.fillStyle = <span class="string">'yellow'</span>;
ctx.lineWidth = <span class="number">5</span>;
ctx.<span class="function">fillRect</span>(<span class="number">100</span>, <span class="number">100</span>, <span class="number">200</span>, <span class="number">100</span>);

<span class="comment">// ‚≠ê RIPRISTINA lo stato originale</span>
ctx.<span class="function">restore</span>();

<span class="comment">// Continua con lo stile originale!</span>
ctx.<span class="function">fillRect</span>(<span class="number">350</span>, <span class="number">100</span>, <span class="number">200</span>, <span class="number">100</span>);
            </div>

            <div class="controls">
                <button onclick="demoPractical()">üé® Demo Save/Restore</button>
                <button onclick="demoNested()">üì¶ Save/Restore Annidati</button>
                <button onclick="clearCanvas2()">üóëÔ∏è Cancella</button>
            </div>
        </div>

        <!-- Sezione 5: Confronto Con/Senza -->
        <div class="section">
            <h2>5. Confronto: Con vs Senza Save/Restore</h2>
            
            <div class="comparison">
                <div class="comparison-item">
                    <h4>‚ùå Senza save/restore</h4>
                    <canvas id="canvas3a" width="280" height="250"></canvas>
                    <div class="code-display" style="font-size: 12px; margin-top: 10px;">
<span class="comment">// ‚ùå MALE</span>
ctx.fillStyle = <span class="string">'blue'</span>;
ctx.<span class="function">fillRect</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">50</span>);

ctx.fillStyle = <span class="string">'red'</span>;
ctx.<span class="function">fillRect</span>(<span class="number">70</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">50</span>);

<span class="comment">// Devo ricordare e reimpostare!</span>
ctx.fillStyle = <span class="string">'blue'</span>;
ctx.<span class="function">fillRect</span>(<span class="number">130</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">50</span>);
                    </div>
                </div>

                <div class="comparison-item">
                    <h4>‚úÖ Con save/restore</h4>
                    <canvas id="canvas3b" width="280" height="250"></canvas>
                    <div class="code-display" style="font-size: 12px; margin-top: 10px;">
<span class="comment">// ‚úÖ BENE</span>
ctx.fillStyle = <span class="string">'blue'</span>;
ctx.<span class="function">fillRect</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">50</span>);

ctx.<span class="function">save</span>();
ctx.fillStyle = <span class="string">'red'</span>;
ctx.<span class="function">fillRect</span>(<span class="number">70</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">50</span>);
ctx.<span class="function">restore</span>();

<span class="comment">// Automaticamente blue!</span>
ctx.<span class="function">fillRect</span>(<span class="number">130</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">50</span>);
                    </div>
                </div>
            </div>

            <div class="controls">
                <button onclick="runComparison()">‚ñ∂Ô∏è Esegui Confronto</button>
            </div>
        </div>
    </div>

    <script>
        // Sezione 1: Demo Base
        const canvas1 = document.getElementById('canvas1');
        const ctx1 = canvas1.getContext('2d');

        function demoBasic() {
            ctx1.clearRect(0, 0, 600, 300);
            
            // Stato iniziale
            ctx1.fillStyle = '#667eea';
            ctx1.fillRect(50, 50, 100, 200);
            
            // Save
            ctx1.save();
            ctx1.fillStyle = '#f5576c';
            ctx1.fillRect(200, 50, 100, 200);
            
            // Restore - torna a #667eea
            ctx1.restore();
            ctx1.fillRect(350, 50, 100, 200);
            
            // Labels
            ctx1.fillStyle = 'white';
            ctx1.font = 'bold 14px Arial';
            ctx1.textAlign = 'center';
            ctx1.fillText('Iniziale', 100, 270);
            ctx1.fillText('Dopo save()', 250, 270);
            ctx1.fillText('Dopo restore()', 400, 270);
        }

        function clearCanvas1() {
            ctx1.clearRect(0, 0, 600, 300);
        }

        demoBasic();

        // Sezione 2: Stack Visuale
        let stackStates = [];
        const stateColors = ['#667eea', '#f5576c', '#43e97b', '#ffa726', '#ab47bc'];

        function updateStackVisual() {
            const stackItems = document.getElementById('stackItems');
            
            if (stackStates.length === 0) {
                stackItems.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Stack vuoto</div>';
                return;
            }
            
            let html = '';
            for (let i = stackStates.length - 1; i >= 0; i--) {
                const isTop = i === stackStates.length - 1;
                html += `
                    <div class="stack-item ${isTop ? 'active' : ''}">
                        Stato ${i + 1} - ${stackStates[i]}
                        ${isTop ? ' ‚Üê TOP' : ''}
                    </div>
                `;
            }
            stackItems.innerHTML = html;
        }

        function pushState() {
            if (stackStates.length < 5) {
                const color = stateColors[stackStates.length];
                stackStates.push(color);
                updateStackVisual();
            } else {
                alert('Stack pieno! (max 5 stati per questo demo)');
            }
        }

        function popState() {
            if (stackStates.length > 0) {
                stackStates.pop();
                updateStackVisual();
            } else {
                alert('Stack vuoto! Nessuno stato da ripristinare.');
            }
        }

        function resetStack() {
            stackStates = [];
            updateStackVisual();
        }

        updateStackVisual();

        // Sezione 4: Uso Pratico
        const canvas2 = document.getElementById('canvas2');
        const ctx2 = canvas2.getContext('2d');

        function demoPractical() {
            ctx2.clearRect(0, 0, 600, 400);
            
            // Stile base
            ctx2.fillStyle = '#667eea';
            ctx2.strokeStyle = '#764ba2';
            ctx2.lineWidth = 3;
            
            // Disegna sfondo
            ctx2.fillRect(0, 0, 600, 400);
            
            // Prima rettangolo normale
            ctx2.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx2.fillRect(50, 50, 150, 100);
            ctx2.strokeRect(50, 50, 150, 100);
            
            // SAVE prima di modifiche temporanee
            ctx2.save();
            
            // Modifiche temporanee
            ctx2.fillStyle = '#ffd700';
            ctx2.strokeStyle = '#ff6b6b';
            ctx2.lineWidth = 5;
            ctx2.fillRect(225, 50, 150, 100);
            ctx2.strokeRect(225, 50, 150, 100);
            
            // Testo "HIGHLIGHT"
            ctx2.fillStyle = '#333';
            ctx2.font = 'bold 16px Arial';
            ctx2.textAlign = 'center';
            ctx2.fillText('HIGHLIGHT', 300, 105);
            
            // RESTORE - torna allo stile base
            ctx2.restore();
            
            // Terzo rettangolo con stile originale ripristinato
            ctx2.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx2.fillRect(400, 50, 150, 100);
            ctx2.strokeRect(400, 50, 150, 100);
            
            // Labels
            ctx2.fillStyle = 'white';
            ctx2.font = 'bold 14px Arial';
            ctx2.fillText('Normale', 125, 180);
            ctx2.fillText('save() ‚Üí modifiche', 300, 180);
            ctx2.fillText('restore() ‚Üí normale', 475, 180);
        }

        function demoNested() {
            ctx2.clearRect(0, 0, 600, 400);
            
            ctx2.fillStyle = '#667eea';
            ctx2.globalAlpha = 1;
            
            for (let i = 0; i < 5; i++) {
                ctx2.save(); // Save per ogni livello
                
                ctx2.globalAlpha = 1 - (i * 0.15);
                ctx2.fillRect(50 + i * 30, 50 + i * 30, 400 - i * 60, 300 - i * 60);
                
                if (i < 4) {
                    ctx2.fillStyle = i % 2 === 0 ? '#764ba2' : '#667eea';
                }
            }
            
            // Restore tutti
            for (let i = 0; i < 5; i++) {
                ctx2.restore();
            }
            
            // Testo con stato originale
            ctx2.fillStyle = 'white';
            ctx2.font = 'bold 20px Arial';
            ctx2.textAlign = 'center';
            ctx2.fillText('5 save() ‚Üí 5 restore()', 300, 350);
        }

        function clearCanvas2() {
            ctx2.clearRect(0, 0, 600, 400);
        }

        // Sezione 5: Confronto
        const canvas3a = document.getElementById('canvas3a');
        const ctx3a = canvas3a.getContext('2d');
        const canvas3b = document.getElementById('canvas3b');
        const ctx3b = canvas3b.getContext('2d');

        function runComparison() {
            // Senza save/restore
            ctx3a.clearRect(0, 0, 280, 250);
            ctx3a.fillStyle = '#667eea';
            ctx3a.fillRect(40, 40, 60, 60);
            
            ctx3a.fillStyle = '#f5576c';
            ctx3a.fillRect(110, 40, 60, 60);
            
            // Devo ricordare e reimpostare!
            ctx3a.fillStyle = '#667eea';
            ctx3a.fillRect(180, 40, 60, 60);
            
            // Con save/restore
            ctx3b.clearRect(0, 0, 280, 250);
            ctx3b.fillStyle = '#667eea';
            ctx3b.fillRect(40, 40, 60, 60);
            
            ctx3b.save();
            ctx3b.fillStyle = '#f5576c';
            ctx3b.fillRect(110, 40, 60, 60);
            ctx3b.restore();
            
            // Automaticamente ripristinato!
            ctx3b.fillRect(180, 40, 60, 60);
        }

        runComparison();
        demoPractical();
    </script>
</body>
</html>
